<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin ‚Äî Vexara Global</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <div class="container">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="logo">üîí Admin Panel</div>
        <button class="theme-toggle" id="themeToggle">‚òÄÔ∏è</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding: 40px 0;">
    <!-- LOGIN -->
    <div id="login-screen">
      <h2>Admin Login</h2>
      <form id="loginForm" style="max-width: 400px; margin: 20px auto;">
        <input type="password" id="adminPass" placeholder="Password" required 
               style="width:100%; padding:12px; margin:10px 0; border:1px solid var(--border-color); border-radius:6px;" />
        <button type="submit" class="btn">Login</button>
        <p id="login-error" style="color:var(--error); margin-top:10px; display:none;">Invalid password</p>
      </form>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" style="display:none;">
      <h2>Manage Clients</h2>
      
      <!-- FORMULAIRE -->
      <form id="clientForm" style="max-width: 700px; margin: 20px auto; background: var(--card-bg); padding: 25px; border-radius: 12px;">
        <input type="hidden" id="clientId" />
        
        <div class="form-row">
          <input type="text" id="full_name" placeholder="Full Name *" required />
          <input type="email" id="email" placeholder="Email *" required />
        </div>

        <div class="form-row">
          <select id="nationality" required>
            <option value="">-- Nationality *</option>
            <option value="Algerian">Algerian</option>
            <option value="American">American</option>
            <option value="French">French</option>            <option value="German">German</option>
            <!-- Ajoute plus si besoin -->
          </select>
          <div>
            <label style="font-size:0.85rem;margin-bottom:6px;display:block;color:var(--gray);">Date of Birth *</label>
            <input type="date" id="date_of_birth" required />
          </div>
        </div>

        <select id="request_type" required>
          <option value="">-- Type *</option>
          <option value="job">Job</option>
          <option value="internship">Internship</option>
          <option value="language-stay">Language Stay</option>
        </select>

        <select id="category" required>
          <option value="">-- Category *</option>
          <option value="IT & Tech">IT & Technology</option>
          <option value="Healthcare">Healthcare</option>
          <option value="Education">Education</option>
          <option value="Engineering">Engineering</option>
        </select>

        <select id="duration" required>
          <option value="">-- Duration *</option>
          <option value="1-3 months">1‚Äì3 months</option>
          <option value="3-6 months">3‚Äì6 months</option>
          <option value="6-12 months">6‚Äì12 months</option>
          <option value="12+ months">12+ months</option>
        </select>

        <select id="status" required>
          <option value="pending">En attente</option>
          <option value="validated">Valid√©</option>
          <option value="expired">Expir√©</option>
          <option value="rejected">Rejet√©</option>
        </select>

        <textarea id="message" placeholder="Notes..." rows="2"></textarea>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn primary">Save Client</button>
          <button type="button" id="deleteBtn" class="btn" style="background: var(--error); display: none;">Delete</button>
        </div>
      </form>

      <!-- LISTE -->
      <div style="margin-top: 40px;">
        <h3>Clients List</h3>        <div id="clientsList" style="margin-top: 15px;"></div>
      </div>
    </div>
  </main>

  <script>
    // === LOGIN ===
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pass = document.getElementById('adminPass').value;
      try {
        const res = await fetch('/.netlify/functions/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pass })
        });
        if (res.ok) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('admin-panel').style.display = 'block';
          loadClients();
        } else {
          document.getElementById('login-error').style.display = 'block';
        }
      } catch (err) {
        alert('Network error');
      }
    });

    // === CHARGER LA LISTE ===
    async function loadClients() {
      try {
        const res = await fetch('/.netlify/functions/applications');
        const clients = await res.json();
        const listDiv = document.getElementById('clientsList');
        listDiv.innerHTML = clients.map(c => `
          <div style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <strong>${c.reference_code}</strong> - ${c.full_name} (${c.status})
            <button onclick="editClient(${c.id})" style="margin-left: 10px; font-size: 0.9rem;">Edit</button>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
      }
    }

    // === √âDITION ===
    window.editClient = async (id) => {
      try {
        const res = await fetch(`/.netlify/functions/applications?id=${id}`);
        const client = await res.json();        
        document.getElementById('clientId').value = client.id;
        document.getElementById('full_name').value = client.full_name;
        document.getElementById('email').value = client.email;
        document.getElementById('nationality').value = client.nationality;
        document.getElementById('date_of_birth').value = client.date_of_birth;
        document.getElementById('request_type').value = client.request_type;
        document.getElementById('category').value = client.category;
        document.getElementById('duration').value = client.duration;
        document.getElementById('status').value = client.status;
        document.getElementById('message').value = client.message || '';
        
        document.getElementById('deleteBtn').style.display = 'inline-block';
      } catch (err) {
        alert('Error loading client');
      }
    };

    // === SUPPRESSION ===
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm('Delete this client?')) return;
      const id = document.getElementById('clientId').value;
      try {
        await fetch('/.netlify/functions/applications', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        resetForm();
        loadClients();
      } catch (err) {
        alert('Delete failed');
      }
    });

    // === SOUMISSION ===
    document.getElementById('clientForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        id: document.getElementById('clientId').value || null,
        full_name: document.getElementById('full_name').value,
        email: document.getElementById('email').value,
        nationality: document.getElementById('nationality').value,
        date_of_birth: document.getElementById('date_of_birth').value,
        request_type: document.getElementById('request_type').value,
        category: document.getElementById('category').value,
        duration: document.getElementById('duration').value,
        status: document.getElementById('status').value,
        message: document.getElementById('message').value      };

      try {
        const res = await fetch('/.netlify/functions/applications', {
          method: data.id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          resetForm();
          loadClients();
        } else {
          alert('Save failed');
        }
      } catch (err) {
        alert('Network error');
      }
    });

    function resetForm() {
      document.getElementById('clientForm').reset();
      document.getElementById('clientId').value = '';
      document.getElementById('deleteBtn').style.display = 'none';
    }

    // Theme + menu
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        const saved = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
        toggle.textContent = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        toggle.addEventListener('click', () => {
          const newTheme = saved === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          toggle.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        });
      }

      const menuToggle = document.getElementById('menuToggle');
      const navMenu = document.getElementById('navMenu');
      if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', () => navMenu.classList.toggle('active'));
      }
    });
  </script>
</body>
</html>
