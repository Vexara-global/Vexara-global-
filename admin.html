<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin ‚Äî Vexara Global</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <div class="container">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="logo">üîí Admin Panel</div>
        <button class="theme-toggle" id="themeToggle">‚òÄÔ∏è</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding: 40px 0;">
    <!-- LOGIN -->
    <div id="login-screen">
      <h2>Admin Login</h2>
      <form id="loginForm" style="max-width: 400px; margin: 20px auto;">
        <input type="password" id="adminPass" placeholder="Password" required 
               style="width:100%; padding:12px; margin:10px 0; border:1px solid var(--border-color); border-radius:6px;" />
        <button type="submit" class="btn">Login</button>
        <p id="login-error" style="color:var(--error); margin-top:10px; display:none;">Invalid password</p>
      </form>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" style="display:none;">
      <h2>Admin Dashboard</h2>

      <!-- Onglets -->
      <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
        <button onclick="showSection('contracts')" class="btn" style="padding:8px 16px;">Contracts</button>
        <button onclick="showSection('submissions')" class="btn" style="padding:8px 16px;">Submissions</button>
        <button onclick="showSection('messages')" class="btn" style="padding:8px 16px;">Messages</button>
      </div>

      <!-- Section Contrats -->
      <div id="contracts-section">
        <h3>Manage Contracts</h3>
        <form id="clientForm" style="max-width: 700px; margin: 20px auto; background: var(--card-bg); padding: 25px; border-radius: 12px;">
          <input type="hidden" id="clientId" />
          
          <div class="form-row">
            <input type="text" id="full_name" placeholder="Full Name *" required />
            <input type="email" id="email" placeholder="Email *" required />
          </div>

          <div class="form-row">
            <select id="nationality" required>
              <option value="">-- Nationality *</option>
              <option value="Algerian">Algerian</option>
              <option value="American">American</option>
              <option value="French">French</option>
              <option value="German">German</option>
              <option value="British">British</option>
              <option value="Canadian">Canadian</option>
              <option value="Italian">Italian</option>
              <option value="Spanish">Spanish</option>
              <option value="Moroccan">Moroccan</option>
              <option value="Egyptian">Egyptian</option>
            </select>
            <div>
              <label style="font-size:0.85rem;margin-bottom:6px;display:block;color:var(--gray);">Date of Birth *</label>
              <input type="date" id="date_of_birth" required />
            </div>
          </div>

          <select id="request_type" required>
            <option value="">-- Type *</option>
            <option value="job">Job</option>
            <option value="internship">Internship</option>
            <option value="language-stay">Language Stay</option>
          </select>

          <select id="category" required>
            <option value="">-- Category *</option>
            <option value="IT & Tech">IT & Technology</option>
            <option value="Healthcare">Healthcare</option>
            <option value="Education">Education</option>
            <option value="Engineering">Engineering</option>
            <option value="Business & Finance">Business & Finance</option>
          </select>

          <select id="duration" required>
            <option value="">-- Duration *</option>
            <option value="1-3 months">1‚Äì3 months</option>
            <option value="3-6 months">3‚Äì6 months</option>
            <option value="6-12 months">6‚Äì12 months</option>
          </select>

          <select id="status" required>
            <option value="pending">En attente</option>
            <option value="validated">Valid√©</option>
            <option value="expired">Expir√©</option>
            <option value="rejected">Rejet√©</option>
          </select>

          <textarea id="message" placeholder="Notes..." rows="2"></textarea>

          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="submit" class="btn primary">Save Contract</button>
            <button type="button" id="deleteBtn" class="btn" style="background: var(--error); display: none;">Delete</button>
          </div>
        </form>

        <div style="margin-top: 40px;">
          <h3>Contracts List</h3>
          <div id="clientsList" style="margin-top: 15px;"></div>
        </div>
      </div>

      <!-- Section Candidatures -->
      <div id="submissions-section" style="display:none;">
        <h3>Candidate Submissions</h3>
        <div id="submissionsList" style="margin-top: 15px;">
          <p>Loading...</p>
        </div>
      </div>

      <!-- Section Messages -->
      <div id="messages-section" style="display:none;">
        <h3>Contact Messages</h3>
        <div id="messagesList" style="margin-top: 15px;">
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // === LOGIN ===
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pass = document.getElementById('adminPass').value;
      try {
        const res = await fetch('/.netlify/functions/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pass })
        });
        if (res.ok) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('admin-panel').style.display = 'block';
          loadClients();
        } else {
          document.getElementById('login-error').style.display = 'block';
        }
      } catch (err) {
        alert('Network error');
      }
    });

    // === CONTRATS ===
    async function loadClients() {
      try {
        const res = await fetch('/.netlify/functions/applications');
        const clients = await res.json();
        const listDiv = document.getElementById('clientsList');
        listDiv.innerHTML = clients.map(c => `
          <div style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <strong>${c.reference_code}</strong> - ${c.full_name} (${c.status})
            <button onclick="editClient(${c.id})" style="margin-left: 10px; font-size: 0.9rem;">Edit</button>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
      }
    }

    window.editClient = async (id) => {
      try {
        const res = await fetch(`/.netlify/functions/applications?id=${id}`);
        const client = await res.json();
        
        document.getElementById('clientId').value = client.id;
        document.getElementById('full_name').value = client.full_name;
        document.getElementById('email').value = client.email;
        document.getElementById('nationality').value = client.nationality;
        document.getElementById('date_of_birth').value = client.date_of_birth;
        document.getElementById('request_type').value = client.request_type;
        document.getElementById('category').value = client.category;
        document.getElementById('duration').value = client.duration;
        document.getElementById('status').value = client.status;
        document.getElementById('message').value = client.message || '';
        
        document.getElementById('deleteBtn').style.display = 'inline-block';
      } catch (err) {
        alert('Error loading client');
      }
    };

    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm('Delete this contract?')) return;
      const id = document.getElementById('clientId').value;
      try {
        await fetch('/.netlify/functions/applications', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        resetForm();
        loadClients();
      } catch (err) {
        alert('Delete failed');
      }
    });

    document.getElementById('clientForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        id: document.getElementById('clientId').value || null,
        full_name: document.getElementById('full_name').value,
        email: document.getElementById('email').value,
        nationality: document.getElementById('nationality').value,
        date_of_birth: document.getElementById('date_of_birth').value,
        request_type: document.getElementById('request_type').value,
        category: document.getElementById('category').value,
        duration: document.getElementById('duration').value,
        status: document.getElementById('status').value,
        message: document.getElementById('message').value
      };

      try {
        const res = await fetch('/.netlify/functions/applications', {
          method: data.id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          resetForm();
          loadClients();
        } else {
          alert('Save failed');
        }
      } catch (err) {
        alert('Network error');
      }
    });

    function resetForm() {
      document.getElementById('clientForm').reset();
      document.getElementById('clientId').value = '';
      document.getElementById('deleteBtn').style.display = 'none';
    }

    // === CANDIDATURES ===
    async function loadSubmissions() {
      try {
        const res = await fetch('/.netlify/functions/applications/submissions');
        const subs = await res.json();
        const container = document.getElementById('submissionsList');
        if (subs.length === 0) {
          container.innerHTML = '<p>No submissions yet.</p>';
          return;
        }
        container.innerHTML = subs.map(s => `
          <div style="background: var(--card-bg); padding: 16px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
            <strong>${s.full_name}</strong> ‚Ä¢ ${s.email}<br>
            <small>${s.nationality} ‚Ä¢ ${s.request_type} ‚Ä¢ ${s.category}</small>
            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="createContractFromSubmission(${s.id})" class="btn" style="font-size:0.85rem; padding:4px 10px;">Create Contract</button>
              <button onclick="deleteSubmission(${s.id})" class="btn" style="font-size:0.85rem; padding:4px 10px; background:#ef4444; color:white;">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('submissionsList').innerHTML = '<p style="color:var(--error);">Failed to load.</p>';
      }
    }

    async function createContractFromSubmission(id) {
      if (!confirm('Create contract from this submission?')) return;
      try {
        const res = await fetch('/.netlify/functions/applications/submissions');
        const subs = await res.json();
        const sub = subs.find(s => s.id == id);
        if (!sub) return alert('Not found');
        
        const response = await fetch('/.netlify/functions/applications/submissions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...sub, submission_id: id })
        });
        
        const result = await response.json();
        alert(`‚úÖ Contract created!\nReference: ${result.reference}`);
        loadSubmissions();
        loadClients();
      } catch (err) {
        alert('Failed to create contract');
      }
    }

    async function deleteSubmission(id) {
      if (!confirm('Delete this submission?')) return;
      try {
        await fetch('/.netlify/functions/applications/submissions', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        loadSubmissions();
      } catch (err) {
        alert('Delete failed');
      }
    }

    // === MESSAGES ===
    async function loadMessages() {
      try {
        const res = await fetch('/.netlify/functions/messages');
        const messages = await res.json();
        const container = document.getElementById('messagesList');
        if (messages.length === 0) {
          container.innerHTML = '<p>No messages yet.</p>';
          return;
        }
        container.innerHTML = messages.map(m => `
          <div style="background: var(--card-bg); padding: 16px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
            <strong>${m.name}</strong> ‚Ä¢ ${m.email}<br>
            <p style="margin: 10px 0; color: var(--text-primary);">${m.message}</p>
            <small style="color: var(--gray);">${new Date(m.submitted_at).toLocaleString()}</small>
            <div style="margin-top: 10px;">
              <button onclick="deleteMessage(${m.id})" class="btn" style="font-size:0.85rem; padding:4px 10px; background:#ef4444; color:white;">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('messagesList').innerHTML = '<p style="color:var(--error);">Failed to load.</p>';
      }
    }

    async function deleteMessage(id) {
      if (!confirm('Delete this message?')) return;
      try {
        await fetch('/.netlify/functions/messages', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        loadMessages();
      } catch (err) {
        alert('Failed to delete message');
      }
    }

    // === ONGLETS ===
    function showSection(section) {
      document.getElementById('contracts-section').style.display = section === 'contracts' ? 'block' : 'none';
      document.getElementById('submissions-section').style.display = section === 'submissions' ? 'block' : 'none';
      document.getElementById('messages-section').style.display = section === 'messages' ? 'block' : 'none';
      
      if (section === 'submissions') loadSubmissions();
      if (section === 'contracts') loadClients();
      if (section === 'messages') loadMessages();
    }

    // === THEME ===
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        const saved = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
        toggle.textContent = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        toggle.addEventListener('click', () => {
          const newTheme = saved === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          toggle.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        });
      }
    });
  </script>
</body>
</html>
